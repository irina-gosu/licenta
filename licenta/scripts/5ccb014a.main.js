function Neighbor(a,b){this.componentId=a,this.neighborPin=b}function Pin(a,b,c){return this.currentMode=b,this.number=c,this.pos=-1,this.value=randomValue,this.connected=0,this.pin_capacities=a,this.neighbors=[],this}function Led(){this.name="Led",this.label="",this.state=0,this.componentId=-1,this.type=0,this.input=new Pin(["input"],"input",1),this.gnd=new Pin(["OUT0"],"OUT0",0),this.pins=[],this.pins.push(this.input),this.pins.push(this.gnd),this.state=this.getState(),this.index=-1}function Resistor(){this.name="Resistor",this.label="",this.componentId=-1,this.pin0=new Pin(["input","output"],"input",0),this.pin1=new Pin(["input","output"],"output",1),this.pins=[],this.pins.push(this.pin0),this.pins.push(this.pin1)}function Button(){this.name="Button",this.label="",this.input=new Pin(["input"],"input",0),this.output=new Pin(["output"],"output",1),this.state=OFF,this.pins=[],this.pins.push(this.input),this.pins.push(this.output),this.componentId=-1}function raspberryPiBoard(){return this.name="raspberryPiBoard",this.pins=[],this.pins[0]=new Pin(["OUT1"],"OUT1",-1),this.pins[1]=new Pin(["OUT1"],"OUT1",-1),this.pins[2]=new Pin(["GPIO_IN","GPIO_OUT","I2C_SDA"],"GPIO_IN",8),this.pins[3]=new Pin(["OUT1"],"OUT1",-1),this.pins[4]=new Pin(["GPIO_IN","GPIO_OUT","I2C_SCL"],"GPIO_IN",9),this.pins[5]=new Pin(["OUT0"],"OUT0",-1),this.pins[6]=new Pin(["GPIO_IN","GPIO_OUT","SPI_CLK"],"GPIO_IN",7),this.pins[7]=new Pin(["GPIO_IN","GPIO_OUT"],"GPIO_IN",15),this.pins[8]=new Pin(["OUT0"],"OUT0",-1),this.pins[9]=new Pin(["GPIO_IN","GPIO_OUT"],"GPIO_IN",16),this.pins[10]=new Pin(["GPIO_IN","GPIO_OUT"],"GPIO_IN",0),this.pins[11]=new Pin(["GPIO_IN","GPIO_OUT","SPI_CLK","PWM"],"GPIO_IN",1),this.pins[12]=new Pin(["GPIO_IN","GPIO_OUT"],"GPIO_IN",2),this.pins[13]=new Pin(["OUT0"],"OUT0",-1),this.pins[14]=new Pin(["GPIO_IN","GPIO_OUT"],"GPIO_IN",3),this.pins[15]=new Pin(["GPIO_IN","GPIO_OUT"],"GPIO_IN",4),this.pins[16]=new Pin(["OUT1"],"OUT1",-1),this.pins[17]=new Pin(["GPIO_IN","GPIO_OUT"],"GPIO_IN",5),this.pins[18]=new Pin(["GPIO_IN","GPIO_OUT","SPI_MOSI"],"GPIO_IN",12),this.pins[19]=new Pin(["OUT0"],"OUT0",-1),this.pins[20]=new Pin(["GPIO_IN","GPIO_OUT","SPI_MISO"],"GPIO_IN",13),this.pins[21]=new Pin(["GPIO_IN","GPIO_OUT"],"GPIO_IN",6),this.pins[22]=new Pin(["GPIO_IN","GPIO_OUT","SPI_CLK"],"GPIO_IN",14),this.pins[23]=new Pin(["GPIO_IN","GPIO_OUT","SPI_SS"],"GPIO_IN",10),this.pins[24]=new Pin(["OUT0"],"OUT0",-1),this.pins[25]=new Pin(["GPIO_IN","GPIO_OUT","SPI_SS"],"GPIO_IN",11),this.pins[26]=new Pin(["I2C_SDA"],"I2C_SDA",-1),this.pins[27]=new Pin(["I2C_SCL"],"I2C_SCL",-1),this.pins[28]=new Pin(["GPIO_IN","GPIO_OUT","SPI_CLK"],"GPIO_IN",21),this.pins[29]=new Pin(["OUT0"],"OUT0",-1),this.pins[30]=new Pin(["GPIO_IN","GPIO_OUT","SPI_CLK"],"GPIO_IN",22),this.pins[31]=new Pin(["GPIO_IN","GPIO_OUT","PWM"],"GPIO_IN",26),this.pins[32]=new Pin(["GPIO_IN","GPIO_OUT","PWM"],"GPIO_IN",23),this.pins[33]=new Pin(["OUT0"],"OUT0",-1),this.pins[34]=new Pin(["GPIO_IN","GPIO_OUT","PWM"],"GPIO_IN",24),this.pins[35]=new Pin(["GPIO_IN","GPIO_OUT"],"GPIO_IN",27),this.pins[36]=new Pin(["GPIO_IN","GPIO_OUT"],"GPIO_IN",25),this.pins[37]=new Pin(["GPIO_IN","GPIO_OUT"],"GPIO_IN",28),this.pins[38]=new Pin(["OUT0"],"OUT0",-1),this.pins[39]=new Pin(["GPIO_IN","GPIO_OUT"],"GPIO_IN",29),this.piBoard=new Board(this.name,this.pins),this.piBoard}function returnPin(a,b,c){return this.mode=a,this.value=b,this.number=c,this}function Board(a,b){return this.name=a,this.label="",this.componentId=-1,this.pins=b,this.assignPinPos(),this}function connectPins(a,b,c,d){switch(b.currentMode.toLowerCase()){case"OUT0".toLowerCase():if(d.currentMode.toLowerCase()!=="OUT0".toLowerCase())return void console.log("This is wrong. This will break. We are not doing this. ");d.neighbors.push(new Neighbor(a.componentId,b));break;case"GPIO_IN".toLowerCase():a.pinMode(b.number,OUTPUT);break;case"INPUT".toLowerCase():if("Resistor"!==a.name)return void console.log("This is wrong. This will break. We are not doing this. ");var e=b.number?0:1;a.pins[b.number].currentMode="output",a.pins[e].currentMode="input";default:switch(d.currentMode.toLowerCase()){case"OUT0".toLowerCase():return void console.log("This is wrong. This will break. We are not doing this. ");case"GPIO_OUT".toLowerCase():c.pinMode(d.number,INPUT);break;case"OUTPUT".toLowerCase():if("Resistor"!==c.name)return void console.log("This is wrong. This will break. We are not doing this. ");var e=d.number?0:1;c.pins[d.number].currentMode="input",c.pins[e].currentMode="output"}}b.connected=1,d.connected=1,b.neighbors.push(new Neighbor(c.componentId,d))}function disconnectPins(a,b,c,d){for(var e=0;e<b.neighbors.length;e++)if(b.neighbors[e].neighborPin===d&&(b.neighbors.splice(e,1),b.currentMode.toLowerCase()==="OUT0".toLowerCase()))for(var f=0;f<d.neighbors.length;f++)d.neighbors[f].neighborPin===b&&(d.neighbors.splice(f,1),b.connected=0,d.connected=0)}function handleGetClick(){$.get(fisier_xml,function(a){var b=$.xml2json(a);parse_netlist(b)})}function getPinFromComponent(a,b){if("raspberryPiBoard"===a.name){if(b.toLowerCase()==="3V3".toLowerCase()||b.toLowerCase()==="5V".toLowerCase())return nothing;if("GND"===b)for(var c=0;c<a.pins.length;c++)if("OUT0"===a.pins[c].pin_capacities[0])return a.pins[c];if(_.startsWith(b,"GPIO")||_.startsWith(b,"GIPO")){if(5===b.length)return a.searchPin(_.parseInt(b[4]));if(6===b.length)return a.searchPin(_.parseInt(b.substr(b.length-2)))}}if("Led"===a.name){if("cathode"===b)return a.gnd;if("anode"===b)return a.input;console.log("Component Led does not have pin "+b)}if("Button"===a.name){if("cathode"===b)return a.output;if("anode"===b)return a.input;console.log("Component Button does not have pin "+b)}if("Resistor"===a.name){if("Pin 0"===b)return a.pin0;if("Pin 1"===b)return a.pin1;console.log("Component Button does not have pin "+b)}}function parse_netlist(a){for(var b=0;b<a.net.length;b++){var c=a.net[b].connector;if(c.length>1){for(var d=[],e=[],f=0;f<c.length;f++){for(var g,h=0,i=0;i<components.length;i++)if(components[i].label===c[f].part.label){h=1,g=components[i],d.push(i);break}h||(c[f].part.title.toLowerCase()==="Raspberry Pi 2".toLowerCase()?g=raspberryPiBoard():"LED"===c[f].part.title.substr(c[f].part.title.length-3)?(g=new Led,initializare_led(g,c[f]),last_led=c[f].part.id):"Button"===c[f].part.title.toLowerCase()?g=new Button:"Resistor"===c[f].part.title.substr(c[f].part.title.length-8)?g=new Resistor:console.log("What is this component? "+c[f].part.title),g.label=c[f].part.label,g.componentId=c[f].part.id,components.push(g),d.push(components.length-1));var j=getPinFromComponent(g,c[f].name);e.push(j)}if(2===d.length)e[0]!=nothing&e[1]!=nothing&&connectPins(components[d[0]],e[0],components[d[1]],e[1]);else for(var f=1;f<d.length;f++)components[d[0]]===components[d[f]]?e[0].number!=e[f].number&&connectPins(components[d[0]],e[0],components[d[f]],e[f]):connectPins(components[d[0]],e[0],components[d[f]],e[f])}}for(var b=0;b<components.length;b++)for(var f=0;f<components[b].pins.length;f++)"OUT0"===components[b].pins[f].currentMode&&(components[b].pins[f].value=0),"OUT1"===components[b].pins[f].currentMode&&(components[b].pins[f].value=1);console.log(components)}function initializare_led(a,b){var c=b.part.title;c=c.substring(c.indexOf("(")+1,c.indexOf(")"));var d=/\d+/g;c=c.match(d),a.type=_.parseInt(c[0]),a.index=_.indexOf(leds,a.type)}function bfs(a,b){for(var c=[],d=a,e=0;d;){if(d.neighbors)for(var f=0;f<d.neighbors.length;f++)d.neighbors[f].neighborPin.value!=a.value&&(d.neighbors[f].neighborPin.setPin(a.value),c.push(d.neighbors[f].neighborPin),e=1,d.neighbors[f].neighborPin.value!=a.value&&console.log("funck yyou"));d=c.shift()}return e}function change_led(a,b){if(b){$("#svg1 svg g[partID="+a.componentId+"] #color_path32").attr("fill",colours_on[a.index])}else{$("#svg1 svg g[partID="+a.componentId+"] #color_path32").attr("fill",colours_off[a.index])}}function simulate(){for(var a=1;1===a;){a=0;for(var b=0,c=0;c<components.length;c++){components[c].name.toLowerCase()==="Resistor".toLowerCase()&&(b=components[c].update_values(),a=1===b||1===a?1:0);for(var d=0;d<components[c].pins.length;d++)b=bfs(components[c].pins[d],components[c]),a=1===b||1===a?1:0;"Resistor"===components[c].name&&(b=components[c].update_values(),a=1===b||1===a?1:0)}}for(var c=0;c<components.length;c++)"Led"===components[c].name&&(components[c].getState()?change_led(components[c],ON):change_led(components[c],OFF));-1!=last_led&&console.log("ledul "+last_led)}function runCode(code){console.log(code),lines=code.split(" ");for(var i=0;i<lines.length;i++)eval(lines[i]),setTimeout(function(){},1e3),console.log(lines[i])}function getFile(a){fisier_svg=a+".svg",fisier_xml=a+".xml"}function timeout(){switch(sistem>5&&(sistem=0),sistem){case 0:components[0].digitalWrite(7,1);break;case 1:components[0].digitalWrite(7,0);break;case 2:components[0].digitalWrite(27,1);break;case 3:components[0].digitalWrite(27,0);break;case 4:components[0].digitalWrite(16,1);break;case 5:components[0].digitalWrite(16,0)}simulate(),sistem++}function timeout2(){switch(sistem>9&&(sistem=0),sistem){case 0:components[0].digitalWrite(4,1);break;case 1:components[0].digitalWrite(4,0);break;case 2:components[0].digitalWrite(24,1);break;case 3:components[0].digitalWrite(24,0);break;case 4:components[0].digitalWrite(12,1);break;case 5:components[0].digitalWrite(12,0);break;case 6:components[0].digitalWrite(16,1);break;case 7:components[0].digitalWrite(16,0);break;case 8:components[0].digitalWrite(6,1);break;case 9:components[0].digitalWrite(6,0)}simulate(),sistem++}function teste(a){switch(a){case"demo":setInterval(timeout,1e3);break;case"demo2":setInterval(timeout2,500);break;case"demo3":setInterval(timeout3,1e3)}}var Z=-100,U=-99,ON=1,OFF=0,GND=0,randomValue=-25,vcc_value=1;Pin.prototype.setPin=function(a){this.value=a};var leds=[940,880,850,660,635,633,620,612,605,595,592,585,574,570,565,560,555,525,505,470,430,4500,6500,8e3],colours_off=["#666666","#999999","#c0c0c0","#ff114d","#ff0000","#e60000","#ff5b0d","#ff9a35","#ff9a35","#fadf47","#fbe446","#ffea00","#deffa2","#17ff8b","#00d76b","#00cc80","#00b33b","#00d9d3","#07d2fe","#3851fe","#0000ee","#cccccc","#ffffff","#ffecfe"],colours_on=["#ffecfe","#ffecfe","#ffecfe","#ffa9bf","#ffa9bf","#ffa9bf","#ffbf9e","#ffbf9e","#ffbf9e","#ffffad","#ffffad","#ffffad","#ffffad","#5dffae","#5dffae","#5dffae","#5dffae","#80ece9","#80ece9","#8897fe","#8897fe","#ccffff","#ccffff","#ccffff"];Led.prototype.getState=function(){return 1===this.input.value&0===this.gnd.value?this.state=ON:this.state=OFF},Resistor.prototype.update_values=function(){var a=0;return"input"===this.pin0.currentMode&&"output"===this.pin1.currentMode&&this.pin0.value!=this.pin0.value&&this.pin0.setPin(this.pin0.value),"output"===this.pin0.currentMode&&"input"===this.pin1.currentMode&&this.pin1.value!=this.pin0.value&&this.pin0.setPin(this.pin1.value),a},Button.prototype.pushed=function(a){1===a&null!=this.output.neighbors&&(this.output.value=this.input.value,this.output.neighbors.push(new Neighbor(this.componentId,this.input)))};var GND=0,value=-25,vcc_value=1,maxPWM=255,maxAIO=1023,vcc_value3=3.3,vcc_value5=5,gnd_value=0,INPUT=0,OUTPUT=1;Board.prototype.assignPinPos=function(){for(var a=0;a<this.pins.length;a++)this.pins[a].pos=a},Board.prototype.searchPin=function(a){for(var b=0;b<this.pins.length;b++)if(this.pins[b].number===a)return this.pins[b]},Board.prototype.digitalRead=function(a){return this.pinMode(a,INPUT),this.searchPin(pin).value},Board.prototype.digitalWrite=function(a,b){this.pinMode(a,OUTPUT),this.searchPin(a).value=b},Board.prototype.pinMode=function(a,b){var c=this.searchPin(a),d=typeof b;return-1==c.pin_capacities.indexOf("GPIO_IN")&&-1==c.pin_capacities.indexOf("GPIO_OUT")?void console.log("This is wrong. This will break. We are not doing this. "+pin):("string"===d?(b.toLowerCase()==="INPUT".toLowerCase()&&(c.currentMode="GPIO_IN"),b.toLowerCase()==="OUTPUT".toLowerCase()&&(c.currentMode="GPIO_OUT")):(b===INPUT&&(c.currentMode="GPIO_IN"),b===OUTPUT&&(c.currentMode="GPIO_OUT")),c.currentMode)},Board.prototype.getPin=function(a){var b=this.searchPin(a);if(null!=b){var c=new returnPin(b.currentMode,b.value,b.number);return c}return void console.log("Found null")},Board.prototype.setPin=function(a,b){var c=this.searchPin(a);c.value=b},Board.prototype.dump=function(){for(var a=[],b=0;b<this.numberOfPins;b++)null!=this.getPin(b)?a.push(this.getPin(b)):console.log("There is no pin "+b);return a};var pi=raspberryPiBoard(),led=new Led,componentele=[];pi.componentId=componentele.length,componentele.push(pi),led.componentId=componentele.length,componentele.push(led);var components=[],nothing=-1,last_led=-1,fisier_xml="",fisier_svg="",lines,el=$("#execute");el.click(function(){$("#code").val()});var load=$("#load");load.click(function(){$("#file").val(),getFile($("#file").val());var a=new XMLHttpRequest;a.open("GET",fisier_svg,!1),a.overrideMimeType("image/svg+xml"),a.send(""),document.getElementById("svg1").appendChild(a.responseXML.documentElement),$(document).ready(function(){handleGetClick(),simulate()}),teste($("#file").val())});var sistem=0;