function Neighbor(a,b){this.componentId=a,this.neighborPin=b}function Pin(a,b,c){return this.currentMode=b,this.number=c,this.pos=-1,this.value=randomValue,this.connected=0,this.pin_capacities=a,this.neighbors=[],this.canModify=1,this}function Led(){this.name="Led",this.label="",this.state=0,this.componentId=-1,this.type=0,this.input=new Pin(["input"],"input",1),this.gnd=new Pin(["OUT0"],"OUT0",0),this.pins=[],this.pins.push(this.input),this.pins.push(this.gnd),this.state=this.getState(),this.index=-1}function Resistor(){this.name="Resistor",this.label="",this.componentId=-1,this.pin0=new Pin(["input","output","OUT0"],"input",0),this.pin1=new Pin(["input","output","OUT0"],"output",1),this.pins=[],this.pins.push(this.pin0),this.pins.push(this.pin1)}function Button(){this.name="Button",this.label="",this.pin0=new Pin(["input","output"],"output",0),this.pin1=new Pin(["OUT1"],"OUT1",1),this.pins=[],this.pins.push(this.pin0),this.pins.push(this.pin1),this.pins[0].setPin(Z),this.componentId=-1}function raspberryPiBoard(){return this.name="raspberryPiBoard",this.pins=[],this.pins[0]=new Pin(["OUT1"],"OUT1",-1),this.pins[1]=new Pin(["OUT1"],"OUT1",-1),this.pins[2]=new Pin(["GPIO_IN","GPIO_OUT","I2C_SDA"],"GPIO_IN",8),this.pins[3]=new Pin(["OUT1"],"OUT1",-1),this.pins[4]=new Pin(["GPIO_IN","GPIO_OUT","I2C_SCL"],"GPIO_IN",9),this.pins[5]=new Pin(["OUT0"],"OUT0",-1),this.pins[6]=new Pin(["GPIO_IN","GPIO_OUT","SPI_CLK"],"GPIO_IN",7),this.pins[7]=new Pin(["GPIO_IN","GPIO_OUT"],"GPIO_IN",15),this.pins[8]=new Pin(["OUT0"],"OUT0",-1),this.pins[9]=new Pin(["GPIO_IN","GPIO_OUT"],"GPIO_IN",16),this.pins[10]=new Pin(["GPIO_IN","GPIO_OUT"],"GPIO_IN",0),this.pins[11]=new Pin(["GPIO_IN","GPIO_OUT","SPI_CLK","PWM"],"GPIO_IN",1),this.pins[12]=new Pin(["GPIO_IN","GPIO_OUT"],"GPIO_IN",2),this.pins[13]=new Pin(["OUT0"],"OUT0",-1),this.pins[14]=new Pin(["GPIO_IN","GPIO_OUT"],"GPIO_IN",3),this.pins[15]=new Pin(["GPIO_IN","GPIO_OUT"],"GPIO_IN",4),this.pins[16]=new Pin(["OUT1"],"OUT1",-1),this.pins[17]=new Pin(["GPIO_IN","GPIO_OUT"],"GPIO_IN",5),this.pins[18]=new Pin(["GPIO_IN","GPIO_OUT","SPI_MOSI"],"GPIO_IN",12),this.pins[19]=new Pin(["OUT0"],"OUT0",-1),this.pins[20]=new Pin(["GPIO_IN","GPIO_OUT","SPI_MISO"],"GPIO_IN",13),this.pins[21]=new Pin(["GPIO_IN","GPIO_OUT"],"GPIO_IN",6),this.pins[22]=new Pin(["GPIO_IN","GPIO_OUT","SPI_CLK"],"GPIO_IN",14),this.pins[23]=new Pin(["GPIO_IN","GPIO_OUT","SPI_SS"],"GPIO_IN",10),this.pins[24]=new Pin(["OUT0"],"OUT0",-1),this.pins[25]=new Pin(["GPIO_IN","GPIO_OUT","SPI_SS"],"GPIO_IN",11),this.pins[26]=new Pin(["I2C_SDA"],"I2C_SDA",-1),this.pins[27]=new Pin(["I2C_SCL"],"I2C_SCL",-1),this.pins[28]=new Pin(["GPIO_IN","GPIO_OUT","SPI_CLK"],"GPIO_IN",21),this.pins[29]=new Pin(["OUT0"],"OUT0",-1),this.pins[30]=new Pin(["GPIO_IN","GPIO_OUT","SPI_CLK"],"GPIO_IN",22),this.pins[31]=new Pin(["GPIO_IN","GPIO_OUT","PWM"],"GPIO_IN",26),this.pins[32]=new Pin(["GPIO_IN","GPIO_OUT","PWM"],"GPIO_IN",23),this.pins[33]=new Pin(["OUT0"],"OUT0",-1),this.pins[34]=new Pin(["GPIO_IN","GPIO_OUT","PWM"],"GPIO_IN",24),this.pins[35]=new Pin(["GPIO_IN","GPIO_OUT"],"GPIO_IN",27),this.pins[36]=new Pin(["GPIO_IN","GPIO_OUT"],"GPIO_IN",25),this.pins[37]=new Pin(["GPIO_IN","GPIO_OUT"],"GPIO_IN",28),this.pins[38]=new Pin(["OUT0"],"OUT0",-1),this.pins[39]=new Pin(["GPIO_IN","GPIO_OUT"],"GPIO_IN",29),this.piBoard=new Board(this.name,this.pins),this.piBoard}function returnPin(a,b,c){return this.mode=a,this.value=b,this.number=c,this}function Board(a,b){return this.name=a,this.label="",this.componentId=-1,this.pins=b,this.assignPinPos(),this}function connectPins(a,b,c,d){switch(b.currentMode.toLowerCase()){case"OUT1".toLowerCase():if(d.currentMode.toLowerCase()!=="OUT1".toLowerCase())return void console.log("This is wrong. This will break. We are not doing this. ");d.neighbors.push(new Neighbor(a.componentId,b));break;case"OUT0".toLowerCase():if(d.currentMode.toLowerCase()==="OUT0".toLowerCase())d.neighbors.push(new Neighbor(a.componentId,b));else{if(-1==d.pin_capacities.indexOf("OUT0"))return void console.log("This is wrong. This will break. We are not doing this. ");d.currentMode="OUT0",d.neighbors.push(new Neighbor(a.componentId,b)),c.update_values()}break;case"GPIO_IN".toLowerCase():a.pinMode(b.number,OUTPUT);break;case"INPUT".toLowerCase():if("Resistor"!==a.name)return void console.log("This is wrong. This will break. We are not doing this. ");var e=b.number?0:1;a.pins[b.number].currentMode="output",a.pins[e].currentMode="input";default:switch(d.currentMode.toLowerCase()){case"OUT0".toLowerCase():return void console.log("This is wrong. This will break. We are not doing this. ");case"GPIO_OUT".toLowerCase():c.pinMode(d.number,INPUT);break;case"OUTPUT".toLowerCase():if("Resistor"!==c.name)return void console.log("This is wrong. This will break. We are not doing this. ");var e=d.number?0:1;c.pins[d.number].currentMode="input",c.pins[e].currentMode="output"}}b.connected=1,d.connected=1,b.neighbors.push(new Neighbor(c.componentId,d))}function disconnectPins(a,b,c,d){for(var e=0;e<b.neighbors.length;e++)if(b.neighbors[e].neighborPin===d&&(b.neighbors.splice(e,1),b.currentMode.toLowerCase()==="OUT0".toLowerCase()))for(var f=0;f<d.neighbors.length;f++)d.neighbors[f].neighborPin===b&&(d.neighbors.splice(f,1),b.connected=0,d.connected=0)}function handleGetClick(){$.get(fisier_xml,function(a){var b=$.xml2json(a);parse_netlist(b)})}function getPinFromComponent(a,b){if("raspberryPiBoard"===a.name){if(b.toLowerCase()==="3V3".toLowerCase()||b.toLowerCase()==="5V".toLowerCase())for(var c=0;c<a.pins.length;c++)if("OUT1"===a.pins[c].pin_capacities[0])return a.pins[c];if("GND"===b)for(var c=0;c<a.pins.length;c++)if("OUT0"===a.pins[c].pin_capacities[0])return a.pins[c];if(_.startsWith(b,"GPIO")||_.startsWith(b,"GIPO")){if(5===b.length)return a.searchPin(_.parseInt(b[4]));if(6===b.length)return a.searchPin(_.parseInt(b.substr(b.length-2)))}}if("Led"===a.name){if("cathode"===b)return a.gnd;if("anode"===b)return a.input;console.log("Component Led does not have pin "+b)}if("Button"===a.name){if("leg1"===b)return a.pin1;if("leg0"===b)return a.pin0;console.log("Component Button does not have pin "+b)}if("Resistor"===a.name){if("Pin 0"===b)return a.pin0;if("Pin 1"===b)return a.pin1;console.log("Component Button does not have pin "+b)}}function parse_netlist(a){for(var b=0;b<a.net.length;b++){var c=a.net[b].connector;if(c.length>1){for(var d=[],e=[],f=[],g=0;g<c.length;g++){for(var h,i=0,j=0;j<components.length;j++)if(components[j].label===c[g].part.label){i=1,h=components[j],e.push(j),d.push(h);break}i||(c[g].part.title.toLowerCase()==="Raspberry Pi 2".toLowerCase()?h=raspberryPiBoard():"LED"===c[g].part.title.substr(c[g].part.title.length-3)?(h=new Led,initializare_led(h,c[g]),last_led=c[g].part.id):c[g].part.title.toLowerCase()==="Pushbutton".toLowerCase()?h=new Button:"Resistor"===c[g].part.title.substr(c[g].part.title.length-8)?h=new Resistor:console.log("What is this component? "+c[g].part.title),h.label=c[g].part.label,h.componentId=c[g].part.id,components.push(h),d.push(h),e.push(components.length-1));var k=getPinFromComponent(h,c[g].name);f.push(k)}if(2===e.length)f[0]!=nothing&f[1]!=nothing&&connectPins(components[e[0]],f[0],components[e[1]],f[1]);else for(var l=-1,m=-1,n=-1,g=1;g<e.length;g++){switch(d[g].name.toLowerCase()){case"Button".toLowerCase():l=g;break;case"Resistor".toLowerCase():m=g;break;case"raspberryPiBoard".toLowerCase():n=g}components[e[0]]===components[e[g]]?f[0].number!=f[g].number&&connectPins(components[e[0]],f[0],components[e[g]],f[g]):-1!=l?connectPins(components[e[g]],f[g],components[e[0]],f[0]):connectPins(components[e[0]],f[0],components[e[g]],f[g])}}}for(var b=0;b<components.length;b++){for(var g=0;g<components[b].pins.length;g++)"OUT0"===components[b].pins[g].currentMode&&(components[b].pins[g].value=0),"OUT1"===components[b].pins[g].currentMode&&(components[b].pins[g].value=1);"Resistor"===components[b].name&&components[b].update_values(),"Button"===components[b].name&&(butonul=b,butonulId=components[b].componentId)}console.log(components),findCamera()}function initializare_led(a,b){var c=b.part.title;c=c.substring(c.indexOf("(")+1,c.indexOf(")"));var d=/\d+/g;c=c.match(d),a.type=_.parseInt(c[0]),a.index=_.indexOf(leds,a.type)}function bfs(a,b){var c=[],d=a;if("Button"!==b.name){for(var e=0;d;){if(d.neighbors)for(var f=0;f<d.neighbors.length;f++)d.neighbors[f].neighborPin.value!=a.value&&d.neighbors[f].neighborPin.canModify&&(d.neighbors[f].neighborPin.setPin(a.value),c.push(d.neighbors[f].neighborPin),e=1);d=c.shift()}return e}}function change_led(a,b){if(b){$("#svg1 svg g[partID="+a.componentId+"] #color_path32").attr("fill",colours_on[a.index])}else{$("#svg1 svg g[partID="+a.componentId+"] #color_path32").attr("fill",colours_off[a.index])}}function runLedCode(){if(-1!=butonul){var a=components[0].digitalRead(4),b=components[0].digitalRead(25);1===a?1!=b&&(components[0].digitalWrite(25,1),switchTheLight(!0)):1===b&&(components[0].digitalWrite(25,0),switchTheLight(!1))}}function simulate(){if(0!==components.length){for(var a=1;1===a;){a=0;for(var b=0,c=0;c<components.length;c++){components[c].name.toLowerCase()==="Resistor".toLowerCase()&&(b=components[c].update_values(),a=1===b||1===a?1:0);for(var d=0;d<components[c].pins.length;d++)b=bfs(components[c].pins[d],components[c]),a=1===b||1===a?1:0}}runLedCode();for(var c=0;c<components.length;c++)"Led"===components[c].name&&(components[c].getState()?change_led(components[c],ON):change_led(components[c],OFF))}}function runCode(code){console.log(code),lines=code.split(" ");for(var i=0;i<lines.length;i++)eval(lines[i]),setTimeout(function(){},1e3),console.log(lines[i])}function getFile(a){fisier_svg=a+".svg",fisier_xml=a+".xml"}function pushButton(){push++,-1!=butonul&&(push%2===0?components[butonul].released():components[butonul].pushed(),simulate())}function timeout(){switch(sistem>5&&(sistem=0),sistem){case 0:components[0].digitalWrite(7,1);break;case 1:components[0].digitalWrite(7,0);break;case 2:components[0].digitalWrite(27,1);break;case 3:components[0].digitalWrite(27,0);break;case 4:components[0].digitalWrite(16,1);break;case 5:components[0].digitalWrite(16,0)}simulate(),sistem++}function timeout2(){switch(sistem>9&&(sistem=0),sistem){case 0:components[0].digitalWrite(4,1);break;case 1:components[0].digitalWrite(4,0);break;case 2:components[0].digitalWrite(24,1);break;case 3:components[0].digitalWrite(24,0);break;case 4:components[0].digitalWrite(12,1);break;case 5:components[0].digitalWrite(12,0);break;case 6:components[0].digitalWrite(16,1);break;case 7:components[0].digitalWrite(16,0);break;case 8:components[0].digitalWrite(6,1);break;case 9:components[0].digitalWrite(6,0)}simulate(),sistem++}function timeout3(){switch(sistem>1&&(sistem=0),sistem){case 0:components[0].digitalWrite(4,1),components[0].digitalWrite(25,1),components[0].digitalWrite(16,1),components[0].digitalWrite(22,0),components[0].digitalWrite(6,0);break;case 1:components[0].digitalWrite(4,0),components[0].digitalWrite(25,0),components[0].digitalWrite(16,0),components[0].digitalWrite(22,1),components[0].digitalWrite(6,1)}simulate(),sistem++}function timeout4(){switch(sistem>4&&(sistem=0),sistem){case 0:components[0].digitalWrite(4,1),components[0].digitalWrite(25,1),components[0].digitalWrite(16,1),components[0].digitalWrite(22,0),components[0].digitalWrite(6,0);break;case 1:components[0].digitalWrite(4,0),components[0].digitalWrite(25,0),components[0].digitalWrite(16,0),components[0].digitalWrite(22,1),components[0].digitalWrite(6,1);break;case 2:components[0].digitalWrite(4,0),components[0].digitalWrite(25,0),components[0].digitalWrite(16,0),components[0].digitalWrite(22,1),components[0].digitalWrite(6,1);break;case 3:components[0].digitalWrite(4,0),components[0].digitalWrite(25,0),components[0].digitalWrite(16,0),components[0].digitalWrite(22,1),components[0].digitalWrite(6,1)}simulate(),sistem++}function teste(a){switch(a){case"demo":setInterval(timeout,1e3);break;case"demo2":setInterval(timeout2,500);break;case"demo3":setInterval(timeout3,200);break;case"buton":}}function butonClick(){console.log("ceva")}var Z=-100,U=-99,ON=1,OFF=0,GND=0,randomValue=-225,vcc_value=1;Pin.prototype.setPin=function(a){this.value=a};var leds=[940,880,850,660,635,633,620,612,605,595,592,585,574,570,565,560,555,525,505,470,430,4500,6500,8e3],colours_off=["#666666","#999999","#c0c0c0","#ff114d","#ff0000","#e60000","#ff5b0d","#ff9a35","#ff9a35","#fadf47","#fbe446","#ffea00","#deffa2","#17ff8b","#00d76b","#00cc80","#00b33b","#00d9d3","#07d2fe","#3851fe","#0000ee","#cccccc","#ffffff","#ffecfe"],colours_on=["#ffecfe","#ffecfe","#ffecfe","#ffa9bf","#ffa9bf","#ffa9bf","#ffbf9e","#ffbf9e","#ffbf9e","#ffffad","#ffffad","#ffffad","#ffffad","#5dffae","#5dffae","#5dffae","#5dffae","#80ece9","#80ece9","#8897fe","#8897fe","#ccffff","#ccffff","#ccffff"];Led.prototype.getState=function(){return 1===this.input.value&0===this.gnd.value?this.state=ON:this.state=OFF},Resistor.prototype.update_values=function(){var a=0;return"input"===this.pin0.currentMode&&"output"===this.pin1.currentMode&&this.pin0.value!=this.pin0.value&&this.pin0.setPin(this.pin0.value),"output"===this.pin0.currentMode&&"input"===this.pin1.currentMode&&this.pin1.value!=this.pin0.value&&this.pin0.setPin(this.pin1.value),"OUT0"===this.pin0.currentMode&&(this.pin1.currentMode="output",this.pin1.value!=this.pin0.value&&(this.pin1.setPin(this.pin0.value),a=1)),"OUT0"===this.pin1.currentMode&&(this.pin0.currentMode="output",this.pin1.value!=this.pin0.value&&(this.pin0.setPin(this.pin1.value),a=1)),a},Button.prototype.pushed=function(){var a=0;if(null!=this.pin0.neighbors){this.pin0.value=this.pin1.value,a=1;for(var b=0;b<this.pin0.neighbors.length;b++)this.pin0.neighbors[b].neighborPin.setPin(this.pin0.value),this.pin0.neighbors[b].neighborPin.canModify=0}return a},Button.prototype.released=function(){var a=0;if(null!=this.pin0.neighbors){this.pin0.setPin(Z),a=1;for(var b=0;b<this.pin0.neighbors.length;b++)this.pin0.neighbors[b].neighborPin.setPin(0),this.pin0.neighbors[b].neighborPin.canModify=1}return a};var GND=0,value=-25,vcc_value=1,maxPWM=255,maxAIO=1023,vcc_value3=3.3,vcc_value5=5,gnd_value=0,INPUT=0,OUTPUT=1;Board.prototype.assignPinPos=function(){for(var a=0;a<this.pins.length;a++)this.pins[a].pos=a},Board.prototype.searchPin=function(a){for(var b=0;b<this.pins.length;b++)if(this.pins[b].number===a)return this.pins[b]},Board.prototype.digitalRead=function(a){return this.pinMode(a,INPUT),this.searchPin(a).value},Board.prototype.digitalWrite=function(a,b){this.pinMode(a,OUTPUT),this.searchPin(a).value=b,simulate()},Board.prototype.pinMode=function(a,b){var c=this.searchPin(a),d=typeof b;return-1==c.pin_capacities.indexOf("GPIO_IN")&&-1==c.pin_capacities.indexOf("GPIO_OUT")?void console.log("This is wrong. This will break. We are not doing this. "+pin):("string"===d?(b.toLowerCase()==="INPUT".toLowerCase()&&(c.currentMode="GPIO_IN"),b.toLowerCase()==="OUTPUT".toLowerCase()&&(c.currentMode="GPIO_OUT")):(b===INPUT&&(c.currentMode="GPIO_IN"),b===OUTPUT&&(c.currentMode="GPIO_OUT")),c.currentMode)},Board.prototype.getPin=function(a){var b=this.searchPin(a);if(null!=b){var c=new returnPin(b.currentMode,b.value,b.number);return c}return void console.log("Found null")},Board.prototype.setPin=function(a,b){var c=this.searchPin(a);c.value=b},Board.prototype.dump=function(){for(var a=[],b=0;b<this.numberOfPins;b++)null!=this.getPin(b)?a.push(this.getPin(b)):console.log("There is no pin "+b);return a};var pi=raspberryPiBoard(),led=new Led,componentele=[];pi.componentId=componentele.length,componentele.push(pi),led.componentId=componentele.length,componentele.push(led);var components=[],nothing=-1,last_led=-1,fisier_xml="",fisier_svg="",butonul=-1,butonulId=-1,lines,el=$("#execute");el.click(function(){$("#code").val()});var push=0,load=$("#load");load.click(function(){$("#file").val(),getFile($("#file").val());var a=new XMLHttpRequest;if(a.open("GET",fisier_svg,!1),a.overrideMimeType("image/svg+xml"),a.send(""),document.getElementById("svg1").appendChild(a.responseXML.documentElement),$(document).ready(function(){handleGetClick(),simulate()}),teste($("#file").val()),"buton"===$("#file").val()){var b=$("#push");b.click(function(){pushButton()})}});var sistem=0;